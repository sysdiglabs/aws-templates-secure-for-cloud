SECURE_API_TOKEN=""

.PHONY: packaged-template.yaml

validate:
	aws cloudformation validate-template --template-body file://./CloudVision.yaml

package-lambdas:
	$(MAKE) -C ../ECSImageScanning/Inline/inline-scanning-lambda lambda.zip
	$(MAKE) -C ../ECSImageScanning/Backend/backend-scanning-lambda lambda.zip
	$(MAKE) -C ../ECRImageScanning/Backend/backend-scanning-lambda lambda.zip

packaged-template.yaml: package-lambdas
	aws cloudformation package \
		--template-file CloudVision.yaml \
		--s3-bucket nestor-test-cf \
		--output-template-file packaged-template.yaml

test: packaged-template.yaml
	aws cloudformation deploy \
		--stack-name "CloudVisionTest" \
		--template-file packaged-template.yaml \
		--capabilities "CAPABILITY_NAMED_IAM" "CAPABILITY_AUTO_EXPAND" \
		--parameter-overrides \
			"SysdigSecureAPIToken=$(SECURE_API_TOKEN)" \
			"ECRImageScanningDeploy=Yes" \
			"ECSImageScanningDeploy=Yes" \
			"CloudBenchDeploy=Yes" \
			"CloudConnectorDeploy=Yes"

ci: package-lambdas
	aws cloudformation package \
		--template-file CloudVision.yaml \
		--s3-bucket $(S3_BUCKET) \
		--s3-prefix $(S3_PREFIX) \
		--force-upload \
		--output-template-file entry-point.yaml
	aws s3 cp ./entry-point.yaml s3://$(S3_BUCKET)/$(S3_PREFIX)/entry-point.yaml

clean:
	aws cloudformation delete-stack --stack-name "CloudVisionTest"
