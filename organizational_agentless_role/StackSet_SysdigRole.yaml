AWSTemplateFormatVersion: "2010-09-09"
Description: Sysdig IAM Role for Security Audit
Parameters:
  OrganizationaUnitId:
    Type: String
    Description: Organizational Unit Id where StackSet is to be applied
  SysdigRoleName:
    Type: String
    Default: "SysdigAgentlessRole"
    Description: Unique role for monitoring AWS accounts
  SysdigExternalID:
    Type: String
    Description: Sysdig ExternalID required for the policy creation
  SysdigTrustedIdentity:
    Type: String
    Description: Sysdig Trusted identity required for policy creation

Resources:
  SysdigRoleStackSet:
    Type: 'AWS::CloudFormation::StackSet'
    Properties:
      StackSetName: SysdigRole
      Description: Deploy a SysdigRole for Security Audit tasks
      PermissionModel: SERVICE_MANAGED
      AutoDeployment:
        Enabled: True
        RetainStacksOnAccountRemoval: False
      ManagedExecution:
        Active: true
      Tags:
        - Key: product
          Value: sysdig-secure-for-cloud
        - Key: stackname
          Value: !Sub "${AWS::StackName}"
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref OrganizationaUnitId
          Regions:
            - ${AWS::Region}
      Parameters:
        - ParameterKey: SysdigRoleName
          ParameterValue: !Ref SysdigRoleName
        - ParameterKey: SysdigExternalID
          ParameterValue: !Ref SysdigExternalID
        - ParameterKey: SysdigTrustedIdentity
          ParameterValue: !Ref SysdigTrustedIdentity
      TemplateBody: |  
        AWSTemplateFormatVersion: "2010-09-09"
        Description: Sysdig IAM Role for Security Audit
        Parameters:
          SysdigRoleName:
            Type: String
            Default: "SysdigAgentlessRole"
            Description: Unique role for monitoring AWS accounts
          SysdigExternalID:
            Type: String
            Description: Sysdig ExternalID required for the policy creation
          SysdigTrustedIdentity:
            Type: String
            Description: Sysdig Trusted identity required for policy creation
        Resources:
          SysdigCloudBench:
            Type: AWS::IAM::Role
            Properties:
              RoleName: !Ref SysdigRoleName
              AssumeRolePolicyDocument:
                Statement:
                  - Effect: Allow
                    Principal:
                      AWS: [ !Ref SysdigTrustedIdentity ]
                    Action: [ 'sts:AssumeRole' ]
                    Condition:
                      StringEquals:
                        sts:ExternalId: !Ref SysdigExternalID
              ManagedPolicyArns:
                - "arn:aws:iam::aws:policy/SecurityAudit"